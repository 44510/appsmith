{
	admin 127.0.0.1:2019
	persist_config off
	servers {
		trusted_proxies static 0.0.0.0/0
	}
}

(file_server) {
	file_server {
		precompressed br gzip
		disable_canonical_uris
	}
}

(reverse_proxy) {
	reverse_proxy {
		to 127.0.0.1:{args[0]}
		header_up -Forwarded
	}
}

{$CADDY_LISTEN_TARGET}

log {
	output stdout
}
skip_log /api/v1/health

header {
	-Server
	Content-Security-Policy "frame-ancestors {$APPSMITH_ALLOWED_FRAME_ANCESTORS:'self' *}"
	X-Content-Type-Options "nosniff"
}

request_body {
	max_size 150MB
}

handle {
	root * {$NGINX_WWW_PATH}
	try_files /loading.html /index.html
	import file_server
}

@file file
handle @file {
	root * /opt/appsmith/editor
	import file_server
	skip_log
}
error /static/* 404

handle /info {
	root * /opt/appsmith
	rewrite * /info.json
	import file_server
}

@backend path /api/* /oauth2/* /login/*
handle @backend {
	import reverse_proxy 8080
}

handle /rts/* {
	import reverse_proxy 8091
}

redir /supervisor /supervisor/
handle_path /supervisor/* {
	import reverse_proxy 9001
}

handle_errors {
	# todo: use 404.html for the 404 error
	respond "{err.status_code} {err.status_text}" {err.status_code}
}

include {$TMP}/caddy/*
